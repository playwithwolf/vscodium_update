# VSCodium 更新服务器 - 快速参考

## 🚀 服务器操作

### 启动服务器
```bash
cd /path/to/vscodium_update
npm start                    # 开发模式
pm2 start ecosystem.config.js  # 生产模式
```

### 检查服务器状态
```bash
curl http://localhost:3000/health
curl http://your-server:3000/versions
```

## 📦 版本管理

### 上传新版本（在服务器上运行）
```bash
# 基本上传
node upload-script.js win32 1.0.1 /path/to/VSCodium-Setup-1.0.1.exe

# 使用自定义下载地址
node upload-script.js win32 1.0.1 /path/to/file.exe -d https://cdn.com/releases

# 为特定文件指定 URL
node upload-script.js win32 1.0.1 /path/to/file.exe -c file.exe=https://cdn.com/file.exe
```

## 🌐 CDN 配置快速参考

### 平台路径自动处理
```bash
# 系统自动添加平台路径，您只需设置基础地址
# 设置: CUSTOM_DOWNLOAD_URL=https://cdn.example.com/releases
# 生成:
# Windows: https://cdn.example.com/releases/win32/file.exe
# macOS:   https://cdn.example.com/releases/darwin/file.dmg
# Linux:   https://cdn.example.com/releases/linux/file.AppImage
```

### CDN 配置方式
```bash
# 方式1: 环境变量（全局配置）
echo "CUSTOM_DOWNLOAD_URL=https://cdn.your-domain.com/releases" >> .env
pm2 restart vscodium-update-server

# 方式2: 上传时指定（平台级）
node upload-script.js win32 1.0.1 /tmp/file.exe -d https://cdn.com/releases

# 方式3: 文件特定URL（最高优先级）
node upload-script.js win32 1.0.1 /tmp/file.exe -c file.exe=https://special-cdn.com/file.exe
```

### CDN 部署检查
```bash
# 1. 验证下载链接生成
curl "http://localhost:3000/update/win32/1.0.0"

# 2. 测试CDN文件访问
curl -I "https://cdn.your-domain.com/releases/win32/VSCodium-Setup.exe"

# 3. 检查文件完整性
curl "https://cdn.your-domain.com/releases/win32/file.exe" | sha256sum

# 4. 刷新CDN缓存（阿里云示例）
aliyun cdn RefreshObjectCaches --ObjectPath https://cdn.your-domain.com/releases/win32/file.exe
```

### 检查更新
```bash
# 检查 Windows 平台从 1.0.0 到最新版本的更新
curl "http://localhost:3000/update/win32/1.0.0"

# 检查所有版本
curl http://localhost:3000/versions
```

## 🔧 VSCodium 配置要点

### 1. 版本号设置
```json
// VSCodium/package.json
{
  "version": "1.0.0"  // 修改这里
}
```

### 2. 更新服务器配置
```json
// VSCodium/product.json
{
  "updateUrl": "http://your-server.com:3000"
}
```

### 3. 主进程集成
```javascript
// 在 VSCodium 主进程中
const { autoUpdater } = require('electron-updater');

autoUpdater.setFeedURL({
  provider: 'generic',
  url: 'http://your-server.com:3000'
});

autoUpdater.checkForUpdatesAndNotify();
```

## 📁 关键文件位置

| 文件 | 作用 |
|------|------|
| `server.js` | 主服务器文件 |
| `upload-script.js` | 版本上传脚本 |
| `versions.json` | 版本信息存储 |
| `releases/` | 文件存储目录 |
| `vscodium-client-example.js` | 客户端示例代码 |

## 🌐 API 端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/health` | GET | 健康检查 |
| `/versions` | GET | 获取所有版本 |
| `/update/:platform/:version` | GET | 检查更新 |
| `/download/:platform/:filename` | GET | 下载文件 |
| `/upload/:platform` | POST | 上传版本 |

## ⚠️ 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| 连接失败 | 服务器未启动 | 检查服务器状态 |
| 版本格式错误 | 不符合 semver | 使用 `1.0.0` 格式 |
| 上传失败 | 权限问题 | 检查 `releases/` 目录权限 |
| 更新不生效 | 版本号相同 | 确保新版本号大于当前版本 |

## 🔍 调试命令

```bash
# 查看服务器日志
pm2 logs vscodium-update-server

# 测试更新接口
curl -v "http://localhost:3000/update/win32/1.0.0"

# 检查文件是否存在
ls -la releases/win32/

# 验证版本信息
cat versions.json | jq .
```

## 📚 完整文档

- **[VSCodium集成详细教程.md](./VSCodium集成详细教程.md)** - 完整的步骤指南
- **[README.md](./README.md)** - API 文档和配置说明
- **[快速参考.md](./快速参考.md)** - 本文档，快速查找命令和配置